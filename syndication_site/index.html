<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>DAM Photo</title>
	<link href="../shared_resources/css/prettyPhoto.css" rel="stylesheet" type="text/css" media="screen" title="prettyPhoto main stylesheet" charset="utf-8" />
    <link href="../shared_resources/css/elvis.css" rel="stylesheet" type="text/css"/>
    <link href="resources/styles.css" rel="stylesheet" type="text/css"/>
    
	<script src="../shared_resources/js/jquery-1.3.2.min.js" type="text/javascript"></script>
	<script src="../shared_resources/js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
		JQ = $;  //rename $ function
	</script>
	<!--
	<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/prototype/1.6.1/prototype.js'></script>
	<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/scriptaculous/1.8.2/scriptaculous.js'></script>
	-->
    <script src="../shared_resources/js/prototype.js" type="text/javascript"></script>
    <script src="../shared_resources/js/elvis.js" type="text/javascript"></script>
	<script type="text/javascript">

        var elvisApi = new ElvisAPI("");

        var CustomHitRenderer = Class.create(HitRenderer, {
        
        	// redefine method
			postProcessTarget: function ($super, targetElement) {
				// call super method
        		$super(targetElement);
        		
        		// prettyPhoto enable our links
        		JQ("a[rel^='prettyPhoto']").prettyPhoto();
    		},

        	// redefine method
			postProcessHit: function ($super, hitElement, hit, index) {
				// call super method
        		$super(hitElement, hit, index);
        		
        		// add buttons
				hitElement.insert('<div class="hitButtons">'
					//+'<input type="image" src="resources/zoom_bg.png" title="Zoom" />'
					+'<input type="image" src="resources/info_bg.png" title="Info" />'
					+'<input type="image" src="resources/price_bg.png" title="Price" />'
					+'<input type="image" src="resources/basket_bg.png" title="Order" />'
					+'</div>');
    		}
        });

        var hitRenderer = new CustomHitRenderer();

        hitRenderer.sharedResources = "../shared_resources";
        hitRenderer.hitsTarget = "resultContainer";
        hitRenderer.infoTarget = "resultInfo";
        hitRenderer.pageTarget = "resultPager";
        hitRenderer.metadataToDisplay = [];
        hitRenderer.linkRel = "prettyPhoto[resultsGallery]";
        hitRenderer.itemClick = function (hit, element) {
        	switch (element.title) {
        	case "Info":
				// TODO show detail page
        		break;
        	case "Price":
        	case "Order":
        		alert("This is a sample.\n\nIf it had not been, your item would have been added to your basket.");
        		break;
        	}
        };
        hitRenderer.pageClick = function (start, num) {
			refresh(start, num);
        };



        var selectedFacets = {};

        function refresh(start, num) {
        	// init defaults for optional parameters
        	if (start == null) {
        		start = 0;
        	}
        	if (num == null) {
        		num = 15;
        	}
        	
        	// build query
        	var query = $F('querystring');
        	
        	query += " +(assetDomain:image OR assetDomain:video)";
        	
        	// add filters
            /*var filters = $("searchFilters").select("a");
            for (var i = 0; i < filters.length; i++) {
                query += " " + filters[i].rel;
            }*/
            for (var facet in selectedFacets) {
            	var filter = "";
            	for (var term in selectedFacets[facet]) {
            		if (selectedFacets[facet][term]) {
	            		if (filter != "") {
	            			filter += " AND "
	            		}
		            	filter += facet + ':"' + term + '"';
		            }
	            }
	            if (filter != "") {
	            	query += " AND (" + filter + ")";
	            }
            }
        	
        	// execute search and update results
            elvisApi.search({
                q: query,
                start: start,
                num: num,
                sort: "name",
                descending: false,
                metadataToReturn: hitRenderer.metadataToDisplay.join(","),
                termFreqsToReturn: "imageType,tags,usageRights"
            }, renderResults);
        }
        
        function renderResults(data) {
        	hitRenderer.render(data);
        	
        	renderFacet(data, "imageType");
        	renderFacet(data, "tags");
        	renderFacet(data, "usageRights");
        }
        
        function renderFacet(data, facet) {
        	var termFreqs = data.termFreqs[facet];
	        
	        var c = Math.min(termFreqs.length, 4);
	        var html = "";
			for (var i = 0; i < c; i++) {
				var term = termFreqs[i].term;
				var freq = termFreqs[i].freq;
				
				var selected = (selectedFacets[facet] && selectedFacets[facet][term]);
				
	            html += '<li><a href="#" onclick="onFacetClick(event, \'#{facet}\', \'#{label}\'); return false"#{classAttr}>#{label}<span>#{freq}</span></a></li>'.interpolate({
	            	facet: facet,
	            	label: term,
	            	freq: freq,
	            	classAttr: (selected ? ' class="selected"' : '')
	            });
	        }
        	
        	$(facet).select("ul")[0].update(html);
        	if (html != "") {
        		$(facet).show();
        	} else {
        		$(facet).hide();
        	}
        }
        
        function onFacetClick(event, facet, term) {
        	if (selectedFacets[facet] == null) {
        		selectedFacets[facet] = {};
        	}

        	// toggle setting
        	var selected = (selectedFacets[facet][term]);
        	selectedFacets[facet][term] = !(selected);
        	
        	// refresh results (and facets)
        	refresh();
        }
        
        function onClearClick() {
	        // clear filters
        	$("querystring").setValue("");
        	selectedFacets = {}
    
        	// refresh results (and facets) 
        	refresh();
        }
        
        document.observe("dom:loaded", function() {
            elvisApi.login("guest", "guest", function (loginResponse) {
                if (loginResponse.loginSuccess) {
                    refresh();
                }
                else {
                    alert("Login failed: " + loginResponse.loginFaultMessage);
                }
            });
        });
		
    </script>
</head>
<body>
<div id="mainWrapper">
	<div id="header">
		<div id="resultInfo">
		</div>
	    <div class="sitenav">
	        <ul>
	        	<li><a>My account</a></li>
	        	<li><a>My lightbox</a></li>
	        	<li><a>Logout</a></li>
	        </ul>
	        <div id="cart">
	            <img src="resources/top_basket.png" alt="Shopping cart" width="49" height="42"/>
	            <p>Items: 0<br />
	            Total: $0,-</p>
	        </div>
	    </div>
	</div>
    <div id="main">
		<div class="searchfilter">
          <h1>Refine your search:</h1>
          <form id="searchFilter" action="#" onsubmit="refresh(); return false">
              <label name="querybar" class="querybar"><input id="querystring" type="text" placeholder="search" /><img src="resources/zoom_bg.png" onclick="refresh()" alt="Search" /></label>
              <div id="imageType" class="facet">
	              <h1>Image type:</h1>
	              <ul>
	              </ul>
              </div>
              <div id="tags" class="facet">
		          <h1>Tags:</h1>
	              <ul>
	              </ul>
              </div>
              <div id="usageRights" class="facet">
		          <h1>Rights:</h1>
	              <ul>
	              </ul>
              </div>
              <div class="clearBtn">
		          <a href="#" onclick="onClearClick(); return false">Clear</a>
              </div>
          </form>
		</div>
		<div class="resultBg"></div>
		<div class="resultWrapper">
			<div id="resultContainer">
			</div>
			<div id="resultPager">
			</div>
		</div>
	    <div id="throbber" style="display:none;">
	        <img src="../shared_resources/images/elvis/ajax-loader.gif" width="16" height="16"/>
	    </div>
	</div>
</div>
</body>
</html>